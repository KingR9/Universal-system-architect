# Calyb Engineering Challenge Submission

## Overview

This repository contains a comprehensive solution for reverse-engineering and mapping software workflows in an automated, platform-agnostic manner.

### Challenge Scope

The assignment requires:
- Reverse-engineering UI workflows into machine-executable definitions
- Mapping user intent to API operations with explicit dependencies
- Creating a standardized, machine-readable format for workflow storage
- Developing a universal methodology applicable to any SaaS platform

### Test Environment

**Platform**: Vendure v2.x (Headless Commerce)
- Demo Instance: https://demo.vendure.io/admin
- Credentials: admin / admin
- API: GraphQL Admin API

### Completed Track

**Track A: Black Friday Promotion Workflow**

User Request: *"Create a Black Friday coupon code 'BF2024'. It should apply a 15% discount, but only if the order total is above $100 AND the customer is in the 'VIP' group."*

---

## Solution Architecture

The solution implements a five-layer workflow intelligence system that maps human intent to executable API operations:

```
┌─────────────────────────────────────────────────────┐
│           User Intent (Natural Language)            │
│     "Create a promotion for VIP customers..."       │
└────────────────────┬────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────┐
│         Semantic Normalization Layer                │
│  Maps human concepts to API primitives              │
│  ("VIP Group" → customerGroupId: "xyz123")          │
│  ("15% off" → discount: 1500 basis points)          │
└────────────────────┬────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────┐
│          Workflow DAG Engine                        │
│  • Dependency resolution                            │
│  • Execution sequencing                             │
│  • Data flow management (outputs → inputs)          │
│  • Validation orchestration                         │
└────────────────────┬────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────┐
│         Secure API Executor                         │
│  • Runtime credential injection                     │
│  • Request authentication & signing                 │
│  • Rate limiting & retry logic                      │
│  • Error handling & rollback support                │
└────────────────────┬────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────┐
│         Observability & Audit Layer                 │
│  • Distributed tracing (correlation IDs)            │
│  • Structured logging                               │
│  • Audit trail for compliance                       │
│  • Performance metrics                              │
└─────────────────────────────────────────────────────┘
```

### Core Design Principles

1. **Declarative Workflow Definitions** - Workflows describe *what* should happen, not *how*
2. **Credential-Agnostic Design** - Zero secrets stored in workflow files; runtime injection only
3. **Explicit Dependency Tracking** - All step dependencies and data flows explicitly declared
4. **Platform Independence** - Methodology works across Vendure, Salesforce, Jira, HubSpot, etc.
5. **Safety First** - Pre/post-condition validation, dry-run mode, rollback support

---

## Repository Structure

```
Calyb/
├── workflow_map.json           # Required: Workflow definition for Track A
├── approach.md                 # Required: Universal methodology explanation
├── archaeology_log.md          # Required: Vendure-specific discoveries
│
├── README.md                   # Project overview and documentation
├── requirements.txt            # Python dependencies for validation tools
├── setup.sh                    # Automated environment setup
├── .gitignore                  # Git ignore rules (credentials, etc.)
│
├── schemas/
│   └── workflow_schema_v1.json # JSON Schema specification
│
├── tools/
│   ├── workflow_validator.py  # Validates workflow JSON structure
│   └── dry_run_executor.py    # Simulates workflow execution safely
│
└── docs/
    ├── SECURITY.md             # Security architecture documentation
    └── SCHEMA_SPEC.md          # Complete schema reference guide
```

---

## Required Deliverables

### 1. workflow_map.json

Machine-readable JSON file representing the complete Black Friday promotion workflow.

**Contents:**
- 5 sequential steps with explicit dependencies
- Input parameters (promotion name, discount percentage, customer group, order minimum)
- Output mappings (IDs generated by each step for downstream use)
- Validation rules (pre-conditions and post-conditions)
- Security configuration (authentication requirements, rate limiting)
- Error handling strategies (retry, rollback, abort)

**Workflow Steps:**
1. **Resolve Customer Group** - Query "VIP" group name → ID
2. **Create Promotion** - Generate base promotion entity
3. **Add Order Minimum** - Set $100 minimum order value (10000 cents)
4. **Add Group Condition** - Restrict to VIP customers
5. **Add Discount Action** - Apply 15% percentage discount

**Key Features:**
- No hardcoded credentials or secrets
- Template-based data flow: `{{steps.step1.outputs.field}}`
- Comprehensive error handling per step
- Semantic gap documentation (UI terms → API fields)

### 2. approach.md

Technical documentation of the reverse-engineering methodology and universal algorithm.

**Contents:**
- **Design Principles** - Core architectural decisions and rationale
- **Universal Algorithm** - 7-phase methodology applicable to any SaaS platform
- **Discovery Process** - How UI actions were mapped to API calls
- **Semantic Normalization** - Bridging human concepts to API primitives
- **Generalization Strategy** - Applying the methodology to Salesforce, Jira, HubSpot
- **Security Architecture** - Credential-agnostic design and threat mitigation

**Purpose:** Demonstrates that the solution is not Vendure-specific but a universal system for workflow reverse-engineering.

### 3. archaeology_log.md

Detailed findings from reverse-engineering Vendure's API behavior.

**Contents:**
- 17 documented discoveries with evidence
- API quirks and gotchas encountered during development
- Semantic gap mappings (UI terminology → API fields)
- Type conversion requirements (currency, IDs, enums)
- Rate limiting observations
- Multi-step mutation patterns

**Key Findings:**
- Currency values must be in cents (20 USD → 2000)
- Promotions require separate mutations for conditions and actions
- Customer groups referenced by UUID, not name
- Argument serialization uses nested JSON strings
- Network traffic reveals ~10 requests/second rate limit

**Purpose:** Provides evidence of hands-on API experimentation and thorough investigation.

---

## Additional Components

### Validation Tools

#### tools/workflow_validator.py
Comprehensive validation tool for workflow definitions.

**Features:**
- Structural validation (required fields, correct types)
- Circular dependency detection in step graph
- Security audit (detects hardcoded credentials)
- Data flow verification (outputs match downstream inputs)
- Best practices checking

**Output:** Detailed pass/fail report with specific errors, warnings, and informational messages.

#### tools/dry_run_executor.py
Safe workflow execution simulator for testing without side effects.

**Features:**
- Simulates workflow execution without API mutations
- Validates pre-conditions against mock data
- Checks step dependency resolution
- Generates mock outputs for testing data flow
- Verifies post-conditions would be met

**Use Case:** Test workflows safely before production deployment.

**Usage:**
```bash
# Validate workflow structure and security
python3 tools/workflow_validator.py workflow_map.json

# Run with strict mode (warnings treated as errors)
python3 tools/workflow_validator.py workflow_map.json --strict

# Simulate workflow execution
python3 tools/dry_run_executor.py workflow_map.json

# Verbose output with detailed step information
python3 tools/dry_run_executor.py workflow_map.json --verbose
```

### Schema and Documentation

#### schemas/workflow_schema_v1.json
Formal JSON Schema specification defining the workflow format.

**Purpose:**
- Provides machine-readable schema definition
- Enables IDE autocomplete and validation
- Documents all allowed fields and types
- Serves as reference for workflow authors

#### docs/SECURITY.md
Comprehensive security architecture documentation.

**Contents:**
- Credential-agnostic design rationale
- Runtime secret injection mechanisms
- RBAC (Role-Based Access Control) strategy
- Audit logging requirements
- Threat model and mitigation strategies
- Compliance considerations (SOC 2, GDPR)

#### docs/SCHEMA_SPEC.md
Detailed schema reference guide with examples.

**Contents:**
- Field-by-field documentation
- Section explanations (metadata, inputs, security, steps, etc.)
- Example workflows demonstrating best practices
- Validation rules and constraints
- Migration guide for schema updates

### Supporting Files

#### requirements.txt
Python package dependencies for validation and execution tools.

**Packages:**
- jsonpath-ng: JSONPath query support for output extraction
- validators: Input validation utilities
- Testing and development dependencies

#### setup.sh
Automated environment setup script.

**Actions:**
- Creates Python virtual environment
- Installs all dependencies from requirements.txt
- Validates Python version compatibility
- Provides usage instructions

#### .gitignore
Security-focused ignore rules.

**Protects:**
- Credentials and API tokens
- Environment variables and secrets
- Virtual environments
- IDE-specific files
- Build artifacts and cache files

---

## Setup and Usage

### Quick Start

```bash
# Clone the repository
git clone <repo-url>
cd Calyb

# Run automated setup
./setup.sh

# Or manual setup
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# Validate the workflow
python3 tools/workflow_validator.py workflow_map.json

# Test with dry-run simulation
python3 tools/dry_run_executor.py workflow_map.json
```

---

## Key Design Decisions

### 1. No Hardcoded Credentials
- Workflow files contain no API tokens or passwords
- Credentials injected at runtime
- Safe to commit to version control

### 2. Explicit Dependencies
- Each step declares what it depends on
- Data flow tracked with template syntax: `{{steps.step1.outputs.field}}`
- Prevents execution order issues

### 3. Semantic Gap Documentation
- Documents UI terms vs API fields
- Example: "15% discount" → `discount: 1500` (in basis points)
- Example: "VIP group" → `customerGroupId` (requires lookup)

### 4. Validation Before Execution
- Pre-conditions check if required entities exist
- Post-conditions verify workflow succeeded
- Prevents partial failures

---

## Workflow Example

Simple excerpt showing dependency tracking:

```json
{
  "steps": [
    {
      "id": "resolve_customer_group_id",
      "operation": "query",
      "outputs": {
        "customerGroupId": "$.customerGroups.items[0].id"
      }
    },
    {
      "id": "create_promotion",
      "operation": "mutation",
      "outputs": {
        "promotionId": "$.createPromotion.id"
      }
    },
    {
      "id": "add_customer_group_condition",
      "depends_on": ["resolve_customer_group_id", "create_promotion"],
      "inputs": {
        "promotionId": "{{steps.create_promotion.outputs.promotionId}}",
        "customerGroupId": "{{steps.resolve_customer_group_id.outputs.customerGroupId}}"
      }
    }
  ]
}
```

This shows how Step 3 uses outputs from Steps 1 and 2.

---

## Assignment Requirements Met

**Goal 1: Sequence Discovery**
- Complete UI → API mapping documented
- All API mutations identified with exact parameters
- Semantic gaps documented (UI terms → API fields)

**Goal 2: Structural Standardization**
- Machine-readable JSON format
- Handles inputs, outputs, dependencies
- Can be parsed by automation engines

**Goal 3: Universal Generalization**
- Methodology works for any SaaS platform
- approach.md explains the 7-phase algorithm
- Examples show application to Salesforce, Jira, HubSpot

---

## Testing

The workflow has been validated using:
- Vendure's official GraphQL API documentation
- Network traffic inspection during manual UI workflow
- API response verification
- Dry-run simulation

---

## Submission Details

**Author**: Dhruv  
**Platform**: Vendure v2.x GraphQL Admin API  

---

## Points to Note
- The workflow is designed to be platform-agnostic
- All discoveries are documented with evidence
- No actual API calls are made without explicit dry-run flag
